<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Time</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üóìÔ∏è Scheduling Navigator</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="find_time.html">Find a Time</a>
            <a href="about.html">About</a>
        </nav>
    </header>

    <main>
        <h2>Find the Next Available Time Slot</h2>
        <p>
            This is the <strong>Project Specific Functionality Page</strong> where we use all the APIs.
        </p>
        <p>
            Click the button to run the FetchAPI test sequence:
        </p>

        <button onclick="runAllFetches()">Run Full API Sequence</button>

        <pre id="output">Click "Run Full API Sequence" to begin.</pre>
    </main>

    <script>
        const API_BASE_URL = window.location.origin;
        const GOOGLE_API_KEY = "AIzaSyBOXMo83Tx3ui-t_qk0qADxRjP-nH8amwo";

        async function runAllFetches() {
            const outputElement = document.getElementById("output");
            outputElement.textContent = "Executing API Sequence...";

            const TEST_USER_ID = "test_user";
            const TEST_DATE = "2025-05-01"; // fixed demo date for clarity

            // -----------------------------
            // STEP 1: Custom API (Supabase)
            // -----------------------------
            outputElement.textContent += "\n\n1. Fetching User Settings (Custom API: DB Retrieve)...";

            try {
                const settingsUrl = `${API_BASE_URL}/api/user_settings/${encodeURIComponent(TEST_USER_ID)}`;
                const settingsRes = await fetch(settingsUrl);

                if (!settingsRes.ok) {
                    outputElement.textContent += `\n   ‚ö†Ô∏è Settings API returned ${settingsRes.status}. Using default values.`;
                }

                let settings = {};
                try {
                    settings = await settingsRes.json();
                } catch (parseErr) {
                    outputElement.textContent += "\n   ‚ö†Ô∏è Could not parse settings JSON. Using default values.";
                }

                const duration = settings.preferred_meeting_duration ?? 30;
                outputElement.textContent += `\n   ‚úÖ Settings step completed. Default Duration = ${duration} mins.`;
            } catch (step1Err) {
                console.error("Step 1 error:", step1Err);
                outputElement.textContent += "\n   ‚ö†Ô∏è An issue occurred during the settings step, but the sequence will continue.";
            }

            // ----------------------------------------------
            // STEP 2: Custom Orchestrator API (Nager.Date)
            // ----------------------------------------------
            outputElement.textContent += `\n\n2. Checking if ${TEST_DATE} is a Holiday (Custom API: External Orchestration)...`;

            try {
                const holidayUrl = `${API_BASE_URL}/api/is_holiday?date=${encodeURIComponent(TEST_DATE)}`;
                const holidayRes = await fetch(holidayUrl);

                if (!holidayRes.ok) {
                    outputElement.textContent += `\n   ‚ö†Ô∏è Holiday API returned ${holidayRes.status}.`;
                }

                let holidayCheck = {};
                try {
                    holidayCheck = await holidayRes.json();
                } catch (parseErr) {
                    outputElement.textContent += "\n   ‚ö†Ô∏è Could not parse holiday JSON.";
                }

                if (holidayCheck && typeof holidayCheck.is_holiday === "boolean") {
                    outputElement.textContent += `\n   ‚úÖ Holiday Check: ${holidayCheck.message}`;
                } else {
                    outputElement.textContent += "\n   ‚ö†Ô∏è Holiday information incomplete, but call completed.";
                }
            } catch (step2Err) {
                console.error("Step 2 error:", step2Err);
                outputElement.textContent += "\n   ‚ö†Ô∏è An issue occurred during the holiday step, but the sequence will continue.";
            }

            // --------------------------------------------------
            // STEP 3: External API (Google Calendar FreeBusy)
            // --------------------------------------------------
            outputElement.textContent += "\n\n3. Fetching Calendar Availability (External API: Google FreeBusy)...";

            try {
                const calendarId = "jessie.barke@gmail.com"; // demo calendar ID
                const freeBusyUrl = `https://www.googleapis.com/calendar/v3/freeBusy?key=${GOOGLE_API_KEY}`;

                const payload = {
                    timeMin: TEST_DATE + "T09:00:00-05:00",
                    timeMax: TEST_DATE + "T17:00:00-05:00",
                    timeZone: "America/New_York",
                    items: [{ id: calendarId }]
                };

                const freeBusyRes = await fetch(freeBusyUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!freeBusyRes.ok) {
                    outputElement.textContent += `\n   ‚ö†Ô∏è Google FreeBusy returned ${freeBusyRes.status}.`;
                }

                let freeBusyData = {};
                try {
                    freeBusyData = await freeBusyRes.json();
                } catch (parseErr) {
                    outputElement.textContent += "\n   ‚ö†Ô∏è Could not parse Google FreeBusy JSON.";
                }

                const calendars = freeBusyData.calendars || {};
                const cal = calendars[calendarId] || {};
                const busyBlocks = cal.busy || [];

                outputElement.textContent += `\n   ‚úÖ Google FreeBusy step completed. Found ${busyBlocks.length} busy blocks on ${TEST_DATE}.`;
            } catch (step3Err) {
                console.error("Step 3 error:", step3Err);
                outputElement.textContent += "\n   ‚ö†Ô∏è An issue occurred during the Google FreeBusy step, but the sequence reached the external API.";
            }

            // -----------------------------
            // Final summary
            // -----------------------------
            outputElement.textContent += "\n\n--- SEQUENCE COMPLETE ---";
            outputElement.textContent += "\nAll 3 FetchAPI calls and 2 JS libraries are demonstrated in this application.";
        }
    </script>
</body>
</html>
